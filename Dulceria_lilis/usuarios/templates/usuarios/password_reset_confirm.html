{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cambiar contraseña - Dulcería Lili</title>
  <link rel="icon" href="{% static 'img/logo.png' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body style="background-color:#f5f6fa;">

<div class="d-flex justify-content-center align-items-center" style="min-height:90vh;">
  <div class="card shadow-lg p-4" style="width:400px; border-radius:15px;">
    <div class="text-center mb-3">
      <img src="{% static 'img/logo.png' %}" width="100" class="mb-2">
      <h5 class="fw-bold text-danger">Cambiar contraseña</h5>
      <p class="text-muted small">Ingresa tu nueva contraseña dos veces para confirmarla.</p>
    </div>

    {% if not error or form %}
      <form method="post" id="formReset">
        {% csrf_token %}
        {{ form.as_p }}
        <button class="btn btn-danger w-100 fw-semibold mt-2" type="submit">
          Guardar nueva contraseña
        </button>
      </form>
    {% endif %}
  </div>
</div>

<script>
  // ✅ Contraseña cambiada correctamente
  {% if request.GET.changed %}
  Swal.fire({
    icon: 'success',
    title: '¡Contraseña actualizada!',
    text: 'Tu nueva contraseña se guardó correctamente.',
    confirmButtonText: 'Ir al login',
    showCancelButton: true,
    cancelButtonText: 'Cerrar correo',
    confirmButtonColor: '#dc3545',
    cancelButtonColor: '#6c757d'
  }).then((result) => {
    if (result.isConfirmed) {
      window.location.href = "{% url 'usuarios:login' %}";
    } else {
      window.close();
    }
  });
  {% endif %}

  // ❌ Enlace inválido o expirado
  {% if error and not form %}
  Swal.fire({
    icon: 'error',
    title: 'Enlace no válido',
    text: '{{ error }}',
    confirmButtonText: 'Volver a intentar',
    confirmButtonColor: '#dc3545'
  }).then(() => {
    window.location.href = "{% url 'usuarios:password_reset' %}";
  });
  {% endif %}

  // ⚠️ Error de validación del formulario (contraseñas no coinciden, débiles, etc.)
  {% if error and form %}
  Swal.fire({
    icon: 'error',
    title: 'Error al guardar contraseña',
    html: `
      <ul style="text-align:left; font-size:14px; color:#333;">
        {% for field, messages in error.items %}
          {% for msg in messages %}
            <li><b>{{ field|title }}</b>: {{ msg }}</li>
          {% endfor %}
        {% endfor %}
      </ul>
    `,
    confirmButtonText: 'Intentar nuevamente',
    confirmButtonColor: '#dc3545'
  });
  {% endif %}
</script>

</body>
</html>
