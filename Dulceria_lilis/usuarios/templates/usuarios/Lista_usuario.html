{% extends 'usuarios/base.html' %}
{% load static %}

{% block title %}Usuarios{% endblock %}

{% block content %}
<div class="container-fluid mt-3 px-0">
  <div class="row g-3 mx-0">

    <!-- ============== FORMULARIO (CREAR) ============== -->
    <div class="col-lg-3 col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title mb-3">Formulario de Usuario</h5>

          <form method="post" action="{% url 'usuarios:crear' %}" novalidate>
            {% csrf_token %}

            {% if form.non_field_errors %}
              <div class="alert alert-danger py-2">
                {% for e in form.non_field_errors %}{{ e }}<br>{% endfor %}
              </div>
            {% endif %}

            <div class="mb-2">
              <label class="form-label small fw-bold">Username</label>
              <input type="text" name="username" class="form-control"
                     value="{{ form.username.value|default:'' }}">
              {% for e in form.username.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="mb-2">
              <label class="form-label small fw-bold">Email</label>
              <input type="text" name="email" class="form-control"
                     value="{{ form.email.value|default:'' }}">
              {% for e in form.email.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="row mb-2">
              <div class="col">
                <label class="form-label small fw-bold">Nombres</label>
                <input type="text" name="nombres" class="form-control"
                       value="{{ form.nombres.value|default:'' }}">
                {% for e in form.nombres.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
              <div class="col">
                <label class="form-label small fw-bold">Apellidos</label>
                <input type="text" name="apellidos" class="form-control"
                       value="{{ form.apellidos.value|default:'' }}">
                {% for e in form.apellidos.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
            </div>

            <div class="mb-2">
              <label class="form-label small fw-bold">Teléfono</label>
              <input type="text" name="telefono" class="form-control"
                     value="{{ form.telefono.value|default:'' }}">
              {% for e in form.telefono.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="row mb-2">
              <div class="col">
                <label class="form-label small fw-bold">Rol</label>
                <select name="rol" class="form-select">
                  <option value="">Seleccione…</option>
                  <option value="ADMIN" {% if form.rol.value == 'ADMIN' %}selected{% endif %}>ADMIN</option>
                  <option value="BODEGA" {% if form.rol.value == 'BODEGA' %}selected{% endif %}>BODEGA</option>
                  <option value="CONSULTA" {% if form.rol.value == 'CONSULTA' %}selected{% endif %}>CONSULTA</option>
                  <option value="PROVEEDOR" {% if form.rol.value == 'PROVEEDOR' %}selected{% endif %}>PROVEEDOR</option>
                  <option value="OPERADOR" {% if form.rol.value == 'OPERADOR' %}selected{% endif %}>OPERADOR</option>
                </select>
                {% for e in form.rol.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
              <div class="col">
                <label class="form-label small fw-bold">Estado</label>
                <select name="estado" class="form-select">
                  <option value="ACTIVO" {% if form.estado.value == 'ACTIVO' %}selected{% endif %}>ACTIVO</option>
                  <option value="INACTIVO" {% if form.estado.value == 'INACTIVO' %}selected{% endif %}>INACTIVO</option>
                  <option value="BLOQUEADO" {% if form.estado.value == 'BLOQUEADO' %}selected{% endif %}>BLOQUEADO</option>
                </select>
                {% for e in form.estado.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
            </div>

            <div class="form-check form-switch mb-3 mt-2">
              <input class="form-check-input" type="checkbox" id="id_mfa" name="mfa_habilitado"
                     {% if form.mfa_habilitado.value %}checked{% endif %}>
              <label class="form-check-label small fw-bold" for="id_mfa">MFA habilitado</label>
              {% for e in form.mfa_habilitado.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="mb-2">
              <label class="form-label small fw-bold">Área / Unidad</label>
              <input type="text" name="area" class="form-control"
                     value="{{ form.area.value|default:'' }}">
              {% for e in form.area.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="mb-2">
              <label class="form-label small fw-bold">Observaciones</label>
              <textarea name="observaciones" class="form-control" rows="2">{{ form.observaciones.value|default:'' }}</textarea>
              {% for e in form.observaciones.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary">Guardar</button>
              <button type="reset" class="btn btn-outline-secondary">Limpiar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ============== TABLA + FILTROS ============== -->
    <div class="col-lg-9 col-md-8">
      <div class="card shadow-sm">
        <div class="card-body">

          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Usuarios</h5>
            <div class="col-md-2 d-grid">
              <a class="btn btn-success"
                 href="?q={{ f_q }}&rol={{ f_rol }}&estado={{ f_estado }}&export=xlsx">
                <i class="bi bi-file-earmark-excel"></i> Exportar Excel
              </a>
            </div>
          </div>

          <!-- Filtros (GET) -->
          <form method="get" action="{% url 'usuarios:lista' %}" class="row g-2 mb-3" id="filtros">
            <div class="col-md-4">
              <input type="text" name="q" value="{{ f_q }}" class="form-control" placeholder="Buscar por username...">
            </div>
            <div class="col-md-3">
              <select name="rol" class="form-select" onchange="this.form.submit()">
                <option value="">Rol: todos</option>
                <option value="ADMIN" {% if f_rol == 'ADMIN' %}selected{% endif %}>ADMIN</option>
                <option value="BODEGA" {% if f_rol == 'BODEGA' %}selected{% endif %}>BODEGA</option>
                <option value="CONSULTA" {% if f_rol == 'CONSULTA' %}selected{% endif %}>CONSULTA</option>
                <option value="PROVEEDOR" {% if f_rol == 'PROVEEDOR' %}selected{% endif %}>PROVEEDOR</option>
                <option value="OPERADOR" {% if f_rol == 'OPERADOR' %}selected{% endif %}>OPERADOR</option>
              </select>
            </div>
            <div class="col-md-3">
              <select name="estado" class="form-select" onchange="this.form.submit()">
                <option value="">Estado: todos</option>
                <option value="ACTIVO" {% if f_estado == 'ACTIVO' %}selected{% endif %}>ACTIVO</option>
                <option value="INACTIVO" {% if f_estado == 'INACTIVO' %}selected{% endif %}>INACTIVO</option>
                <option value="BLOQUEADO" {% if f_estado == 'BLOQUEADO' %}selected{% endif %}>BLOQUEADO</option>
              </select>
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-primary">Filtrar</button>
            </div>
          </form>

          <!-- Tabla -->
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Nombre completo</th>
                  <th>Teléfono</th>
                  <th>Rol</th>
                  <th>Estado</th>
                  <th>MFA</th>
                  <th>Último acceso</th>
                  <th>Área</th>
                  <th>Sesiones</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for usuario in usuarios %}
                <tr>
                  <td>{{ usuario.username }}</td>
                  <td>{{ usuario.email }}</td>
                  <td>{{ usuario.nombres }} {{ usuario.apellidos }}</td>
                  <td>{{ usuario.telefono|default:"—" }}</td>
                  <td>
                    {% if usuario.rol == 'BODEGA' %}
                      <span class="badge bg-warning text-dark">BODEGA</span>
                    {% elif usuario.rol == 'CONSULTA' %}
                      <span class="badge bg-info text-dark">CONSULTA</span>
                    {% elif usuario.rol == 'ADMIN' %}
                      <span class="badge bg-danger">ADMIN</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ usuario.rol }}</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if usuario.estado == 'ACTIVO' %}
                      <span class="badge bg-success">ACTIVO</span>
                    {% elif usuario.estado == 'BLOQUEADO' %}
                      <span class="badge bg-danger">BLOQUEADO</span>
                    {% elif usuario.estado == 'INACTIVO' %}
                      <span class="badge bg-warning text-dark">INACTIVO</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ usuario.estado }}</span>
                    {% endif %}
                  </td>
                  <td>{% if usuario.mfa_habilitado %}Sí{% else %}No{% endif %}</td>
                  <td>{% if usuario.ultimo_acceso %}{{ usuario.ultimo_acceso|date:"Y-m-d H:i" }}{% else %}—{% endif %}</td>
                  <td>{{ usuario.area|default:"—" }}</td>
                  <td>{{ usuario.sesiones }}</td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <a href="{% url 'usuarios:editar' usuario.pk %}" class="btn btn-warning text-white">
                        <i class="bi bi-pencil"></i>
                      </a>

                      <a href="{% url 'usuarios:resetear_clave' usuario.pk %}" 
                          class="btn btn-secondary text-white"
                          onclick="return confirm('¿Resetear clave de {{ usuario.username }}?')">
                          <i class="bi bi-key"></i>
                      </a>

                      <button type="button"
                              class="btn btn-danger"
                              onclick="confirmarEliminacion('{{ usuario.pk }}','{{ usuario.username }}')">
                        <i class="bi bi-trash"></i>
                      </button>

                      <form id="del-{{ usuario.pk }}" action="{% url 'usuarios:eliminar' usuario.pk %}" method="post" style="display:none">
                        {% csrf_token %}
                      </form>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="11" class="text-center text-muted py-3">No hay usuarios registrados.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function confirmarEliminacion(id, username) {
    Swal.fire({
      title: '¿Eliminar usuario?',
      html: `Se eliminará <b>${username}</b>. Esta acción no se puede deshacer.`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar',
      confirmButtonColor: '#d33',
      cancelButtonColor: '#6c757d',
      reverseButtons: true,
    }).then((r) => {
      if (r.isConfirmed) {
        document.getElementById(`del-${id}`).submit();
      }
    });
  }
</script>
{% endblock %}